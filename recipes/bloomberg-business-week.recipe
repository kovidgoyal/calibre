from calibre.web.feeds.news import BasicNewsRecipe, classes
from calibre import browser
from html5_parser import parse
import json


class Bloomberg(BasicNewsRecipe):
    title = u'Bloomberg Businessweek'
    language = 'en'
    __author__ = 'unkn0wn'
    no_stylesheets = True
    use_embedded_content = False
    remove_attributes = ['style', 'height', 'width']
    ignore_duplicate_articles = {'url'}
    resolve_internal_links = True
    masthead_url = 'https://assets.bwbx.io/s3/javelin/public/hub/images/BW-Logo-Black-cc9035fbb3.svg'
    delay = 7 # seconds
    extra_css = '''
        #auth {font-size:small; font-weight:bold;}
        #time, .chart {font-size:small;}
        #subhead {font-style:italic; color:#404040;}
        .news-figure-caption-text, #cap, #img {font-size:small; text-align:center;}
        .news-figure-credit {font-size:small; text-align:center; color:#202020;}
    '''

    remove_tags = [
        dict(name='div', attrs={'id':['bb-that', 'bb-nav']}),
        classes('twitter-logo bb-global-footer')
    ]

    def get_browser(self):
        br = browser()
        br.set_handle_redirect(False)
        return br

    def parse_index(self):
        soup = self.index_to_soup('https://www.bloomberg.com/businessweek')
        bw = soup.find('a', href=lambda x: x and x.startswith('/magazine/businessweek/'))
        edition = 'https://www.bloomberg.com' + bw['href']
        self.log('Downloading ', edition)
        self.cover_url = bw.find('img')['src'].replace('25x19', '600x800')
        soup = self.index_to_soup(edition)
        timefmt = soup.find(**classes('section-front-header-module__title'))
        if timefmt:
            self.timefmt = ' [' + (self.tag_to_string(timefmt).replace('Issue', '')).strip() + ']'

        feeds = []
        for div in soup.findAll('div', attrs={'class':'story-list-module__info'}):
            h3 = div.find('h3', attrs={'class':'story-list-module__title'})
            sec = self.tag_to_string(h3)
            self.log(sec)
            articles = []
            for art in div.findAll('article'):
                a = art.find('a', **classes('story-list-story__info__headline-link'))
                url = a['href']
                if url.startswith('http') is False:
                    url = 'https://www.bloomberg.com' + a['href']
                title = self.tag_to_string(a)
                desc = ''
                sum = art.find(**classes('story-list-story__info__summary'))
                if sum:
                    desc = self.tag_to_string(sum).strip()
                by = art.find(**classes('story-list-story__info__byline'))
                if by:
                    desc = self.tag_to_string(by).strip() + ' | ' + desc
                articles.append({'title': title, 'url': url, 'description': desc})
                self.log('\t', title, '\n\t', desc, '\n\t\t', url)
            if articles:
                feeds.append((sec, articles))
        return feeds

    def preprocess_raw_html(self, raw, *a):
        root = parse(raw)
        m = root.xpath('//script[@data-component-props="ArticleBody"]')
        if not m:
            m = root.xpath('//script[@data-component-props="FeatureBody"]')
            if not m:
                m2 = root.xpath('//script[@id="__NEXT_DATA__"]')
                if not m2:
                    return raw
        if m:
            data = json.loads(m[0].text)
            data = data['story']

        else:
            data = json.loads(m2[0].text)
            data = data['props']['pageProps']['story']

        title = '<h1>' + data['headline'] + '</h1>'

        cat = subhead = lede = auth = caption = ''

        if 'primaryCategory' in data:
            if data['primaryCategory'] is not None:
                cat = '<p id="cat">' + data['primaryCategory'] + '</p>'

        if len(data['abstract']) != 0:
            if len(data['abstract']) == 2:
                subhead = '<div id="subhead"><p>' + data['abstract'][0] + '</p><p>' + data['abstract'][1] + '</p></div>'
        else:
            if 'summary' in data:
                subhead = '<div id="subhead"><p>' + data['summary'] + '</p></div>'

        if 'byline' in data:
            if data['byline'] is not None:
                auth = '<div><span id="auth">' + data['byline']\
                 + '</span> | <span id="time">' + data['publishedAt'][:-14] + '</span></div>'

        if 'ledeImageUrl' in data:
            if data['ledeImageUrl'] is not None:
                lede = '<p id="img"><img src="{}">'.format(data['ledeImageUrl'])

        if 'ledeDescription' in data:
            if data['ledeDescription'] is not None:
                caption = '<span id="cap">' + data['ledeDescription'] + '</span>'
        else:
            if 'lede' in data:
                if data['lede'] is not None:
                    if 'alt' in data['lede']:
                        if data['lede']['alt'] is not None:
                            caption = '<span id="cap">' + data['lede']['alt'] + '</span>'

        if m:
            body = data['body']
        else:
            body = ''
            body_data = data['body']['content']

            for objects in body_data:

                if objects['type'] == 'media' and objects['subType'] == 'photo':
                    body += '<p id="img"><img src="{}">'.format(objects['data']['photo']['src'])
                    body += '<span>' + objects['data']['photo']['caption'] + '</span></p>'
                if objects['type'] == 'media' and objects['subType'] == 'chart':
                    if objects['data'] and objects['data']['chart']:
                        body += '<p id="img"><img src="{}">'.format(objects['data']['chart']['fallback'])

                if objects['type'] == 'paragraph' or 'heading':     # lists are missed :(
                    body += '<p>'

                    if 'content' not in objects:
                        continue

                    for item in objects['content']:
                        
                        if item['type'] == 'text' and item['value']:
                            body += item['value']
                            
                        if item['type'] == 'link' and item['data']:
                            if 'href' not in item['data']:
                                continue
                            if item['content'] and item['content'][0] and item['content'][0]['value']:
                                body += '<a href="' + item['data']['href'] + '">' + item['content'][0]['value'] + '</a>'
                        
                        if item['type'] == 'entity':
                            if item['content'] and item['content'][0] and item['content'][0]['value']:
                                if item['subType'] == 'person' or 'security':
                                    body += item['content'][0]['value']
                                if item['subType'] == 'story':
                                    if item['data'] and item['data']['link'] and item['data']['link']['destination'] and item['data']['link']['destination']['web']:
                                        body += '<a href="' + item['data']['link']['destination']['web'] + '">' + item.content[0].value + '</a>'

                if objects['type'] == 'quote':
                    if 'content' not in objects:
                        continue
                    for item in objects['content']:
                        if item['type'] == 'paragraph' and item['content'] and item['content'][0]:
                            if 'value' not in item['content'][0]:
                                continue
                            body += '<blockquote id="subhead">' + item['content'][0]['value'] + '</blockquote>'

        html = '<html><body>' + cat + title + subhead + auth + lede + caption + '<div>' + body
        return html

    def preprocess_html(self, soup):
        for icon in soup.findAll('img', attrs={'class':'video-player__play-icon'}):
            icon.decompose()
        for div in soup.findAll('div', attrs={'class':'chart'}):
            nos = div.find('noscript')
            if nos:
                nos.name = 'span'
        for img in soup.findAll('img', attrs={'data-native-src':True}):
            if img['data-native-src'].__contains__('videos') is False:
                img['src'] = img['data-native-src']
            else:
                img['src'] = ''
        for img in soup.findAll('img', attrs={'src':lambda x: x and x.endswith(('-1x-1.jpg', '-1x-1.png'))}):
            img['src'] = img['src'].replace('-1x-1', '750x-1')
        return soup
